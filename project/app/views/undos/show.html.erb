<%# app/views/undos/index.html.erb %>

<%= render "frontend/header" %>
<div class="main-content">
  <%= render "frontend/sidebar" %>
  <div class="content-area">
    <div class="tab-content active">
      <div class="section-header">
        <h2><i class="fas fa-history"></i> История изменений</h2>
        <% if @history.any? %>
          <span class="badge"><%= @history.size %> операций</span>
        <% end %>
      </div>

      <div class="backup-container">
        <div class="backup-card history-card" style="
            display: flex;
            flex-direction: column;
            height: 550px; /* Фиксированная высота всей карточки */
            max-height: 550px;">
          
          <!-- Верхняя часть - заголовок и статистика -->
          <div style="flex-shrink: 0;">
            <div class="backup-icon">
              <i class="fas fa-history"></i>
            </div>

            <h3 style="margin: 0.5rem 0 0.2rem 0; font-size: 1.3rem;">История операций</h3>
            <p class="subtitle" style="margin-bottom: 0.8rem; color: var(--gray-color); font-size: 0.9rem;">
              Список последних изменений в системе
            </p>

            <div class="history-stats" style="
                display: flex;
                justify-content: center;
                gap: 1.5rem;
                padding: 0.6rem;
                background: linear-gradient(135deg, rgba(74, 108, 247, 0.05), rgba(106, 17, 203, 0.05));
                border-radius: 8px;
                margin: 0.5rem 0 1rem 0;">
              <div class="stat" style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem;">
                <i class="fas fa-database" style="color: var(--primary-color);"></i>
                <span>Всего: <strong style="color: var(--dark-color);"><%= @history.size %></strong></span>
              </div>
              <% if @history.any? %>
                <div class="stat" style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem;">
                  <i class="fas fa-exclamation-triangle" style="color: #e74c3c;"></i>
                  <span>Удалено: <strong style="color: var(--dark-color);"><%= @history.count { |h| h["type"] == "delete" } %></strong></span>
                </div>
              <% end %>
            </div>
          </div>

          <!-- Средняя часть - список истории -->
          <div style="
              flex: 1 1 auto;
              min-height: 0;
              display: flex;
              flex-direction: column;">
            
            <% if @history.empty? %>
              <div class="empty-history" style="
                  flex: 1;
                  display: flex;
                  flex-direction: column;
                  align-items: center;
                  justify-content: center;
                  padding: 2rem;
                  text-align: center;
                  color: var(--gray-color);">
                <i class="fas fa-clipboard-list" style="font-size: 3rem; margin-bottom: 1rem; color: #ccc;"></i>
                <p style="margin-bottom: 0.3rem; font-weight: 500;">История изменений пуста</p>
                <small>Здесь будут отображаться все операции</small>
              </div>
            <% else %>
              <!-- Контейнер для прокрутки -->
              <div style="
                  flex: 1;
                  min-height: 0;
                  overflow-y: auto;
                  padding-right: 8px;">
                
                <% @history.each_with_index do |item, index| %>
                  <div class="history-item" style="
                      background: white;
                      border-radius: 8px;
                      padding: 0.8rem;
                      margin-bottom: 0.6rem;
                      border: 1px solid #e9ecef;
                      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
                      <%= 'border-left: 4px solid #e74c3c;' if item["type"] == "delete" %>">
                    
                    <!-- Заголовок операции -->
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.3rem;">
                      <span style="
                          background: #495057;
                          color: white;
                          width: 22px;
                          height: 22px;
                          border-radius: 50%;
                          display: flex;
                          align-items: center;
                          justify-content: center;
                          font-size: 0.7rem;
                          font-weight: bold;">#<%= index + 1 %></span>
                      
                      <span style="
                          padding: 0.15rem 0.5rem;
                          border-radius: 10px;
                          font-size: 0.65rem;
                          font-weight: 600;
                          background: <%= item["type"] == 'delete' ? '#fee' : (item["type"] == 'create' ? '#e8f5e9' : '#e3f2fd') %>;
                          color: <%= item["type"] == 'delete' ? '#c62828' : (item["type"] == 'create' ? '#2e7d32' : '#1565c0') %>;
                          display: inline-flex;
                          align-items: center;
                          gap: 0.3rem;">
                        <i class="fas <%= item["type"] == 'delete' ? 'fa-trash' : (item["type"] == 'create' ? 'fa-plus' : 'fa-edit') %>" style="font-size: 0.65rem;"></i>
                        <%= item["type"].upcase %>
                      </span>
                      
                      <span style="
                          font-size: 0.75rem;
                          color: #666;
                          font-weight: 500;
                          display: inline-flex;
                          align-items: center;
                          gap: 0.3rem;">
                        <i class="fas fa-table" style="font-size: 0.65rem;"></i>
                        <%= item["entity"] %>
                      </span>
                    </div>
                    
                    <!-- Данные клиента -->
                    <% if item["snapshot"] && item["snapshot"]["first_name"] %>
                      <div style="margin-top: 0.4rem; padding-top: 0.4rem; border-top: 1px dashed #e9ecef;">
                        <div style="
                            font-size: 0.85rem;
                            font-weight: 600;
                            color: #212529;
                            margin-bottom: 0.2rem;
                            line-height: 1.2;">
                          <%= item["snapshot"]["last_name"] %> 
                          <%= item["snapshot"]["first_name"] %> 
                          <%= item["snapshot"]["patronymic"] %>
                        </div>
                        
                        <div style="
                            display: flex;
                            flex-wrap: wrap;
                            gap: 0.8rem;
                            font-size: 0.75rem;
                            color: #495057;">
                          <% if item["snapshot"]["phone_number"] %>
                            <span style="display: flex; align-items: center; gap: 0.3rem;">
                              <i class="fas fa-phone" style="color: var(--primary-color); font-size: 0.7rem;"></i>
                              <%= item["snapshot"]["phone_number"] %>
                            </span>
                          <% end %>
                          
                          <% if item["snapshot"]["registration_date"] %>
                            <span style="display: flex; align-items: center; gap: 0.3rem;">
                              <i class="fas fa-calendar-alt" style="color: var(--primary-color); font-size: 0.7rem;"></i>
                              <%= Date.parse(item["snapshot"]["registration_date"]).strftime("%d.%m.%Y") rescue item["snapshot"]["registration_date"] %>
                            </span>
                          <% end %>
                        </div>
                      </div>
                    <% end %>
                  </div>
                <% end %>
              </div>
            <% end %>
          </div>

          <!-- Нижняя часть - кнопка -->
          <div style="
              flex-shrink: 0;
              padding-top: 1rem;
              margin-top: auto;
              border-top: 1px solid var(--border-color);
              text-align: center;">
            
            <%= button_to undo_path, 
                  method: :post, 
                  class: "btn-primary",
                  style: "padding: 0.6rem 1.2rem; font-size: 0.85rem;",
                  disabled: @history.empty? do %>
              <i class="fas fa-undo"></i> Отменить последнее
            <% end %>
            
            <div style="
                margin-top: 0.4rem;
                font-size: 0.75rem;
                color: var(--gray-color);
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 0.3rem;">
              <i class="fas fa-info-circle"></i>
              Отменить можно только последнюю операцию
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<%= render "frontend/modals_create" %>
<%= render "frontend/modals_delete" %>
<%= render "shared/confirm_dialog" %>
<%= render "shared/notification" %>